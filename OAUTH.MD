# OAuth Servisi API Ä°ÅŸleyiÅŸi - GÃ¼ncel ve DetaylÄ±

Bu dokÃ¼manda, OAuth 2.0 servisinin API iÅŸleyiÅŸini gerÃ§ek verilerle aÃ§Ä±klayacaÄŸÄ±m.

## ðŸ“‹ Ä°Ã§indekiler
1. [OAuth 2.0 Nedir?](#oauth-20-nedir)
2. [API Endpoint'leri](#api-endpointleri)
3. [Scope Sistemi](#scope-sistemi)
4. [OAuth AkÄ±ÅŸÄ±](#oauth-akÄ±ÅŸÄ±)
5. [GÃ¼venlik MekanizmalarÄ±](#gÃ¼venlik-mekanizmalarÄ±)
6. [Token TÃ¼rleri](#token-tÃ¼rleri)
7. [GerÃ§ek API YanÄ±tlarÄ±](#gerÃ§ek-api-yanÄ±tlarÄ±)
8. [Hata YÃ¶netimi](#hata-yÃ¶netimi)

---

## ðŸ” OAuth 2.0 Nedir?

OAuth 2.0, Ã¼Ã§Ã¼ncÃ¼ taraf uygulamalarÄ±n kullanÄ±cÄ± adÄ±na kaynaklara eriÅŸim saÄŸlamasÄ±na izin veren bir yetkilendirme protokolÃ¼dÃ¼r.

### Temel AktÃ¶rler:
- **Resource Owner (Kaynak Sahibi)**: KullanÄ±cÄ±
- **Client (Ä°stemci)**: Uygulama (web, mobil, desktop)
- **Authorization Server (Yetkilendirme Sunucusu)**: OAuth saÄŸlayÄ±cÄ±sÄ±
- **Resource Server (Kaynak Sunucusu)**: API sunucusu

---

## ðŸŒ API Endpoint'leri

### 1. Authorization Endpoint
```
GET /api/v2/oauth/authorize
```

**AmaÃ§:** KullanÄ±cÄ±yÄ± giriÅŸ sayfasÄ±na yÃ¶nlendirir ve yetkilendirme kodu alÄ±r.

**Parametreler:**
- `response_type`: "code" (authorization code flow iÃ§in)
- `client_id`: Uygulama kimliÄŸi
- `redirect_uri`: Geri dÃ¶nÃ¼ÅŸ adresi
- `scope`: Ä°stenen izinler
- `state`: CSRF korumasÄ± iÃ§in rastgele deÄŸer
- `code_challenge`: PKCE iÃ§in gÃ¼venlik kodu
- `code_challenge_method`: "S256" (SHA256)

**Ã–rnek Ä°stek:**
```
GET /api/v2/oauth/authorize?
  response_type=code&
  client_id=pSsyy6i3D7rGyK8Hpt68Uw&
  redirect_uri=https://ozet.today/api/oauth-callback&
  scope=openid%20profile%20email%20details%20phone&
  state=abc123&
  code_challenge=xyz789&
  code_challenge_method=S256
```

### 2. Token Endpoint
```
POST /api/v2/oauth/token
```

**AmaÃ§:** Authorization code'u access token'a Ã§evirir.

**Parametreler:**
- `grant_type`: "authorization_code"
- `code`: Authorization endpoint'ten dÃ¶nen kod
- `redirect_uri`: Authorization'da kullanÄ±lan aynÄ± URI
- `client_id`: Uygulama kimliÄŸi
- `client_secret`: Uygulama gizli anahtarÄ± (varsa)
- `code_verifier`: PKCE verifier'Ä±

**BaÅŸarÄ±lÄ± YanÄ±t:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "def456ghi789",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 3. UserInfo Endpoint
```
GET /api/v2/oauth/userinfo
```

**AmaÃ§:** Access token ile kullanÄ±cÄ± bilgilerini alÄ±r.

**Headers:**
- `Authorization: Bearer {access_token}`

---

## ðŸ“‹ Scope Sistemi

### Mevcut Scope'lar:

| Scope | AÃ§Ä±klama | DÃ¶nen Veriler |
|-------|----------|---------------|
| `openid` | OpenID Connect kimlik doÄŸrulama | Temel kimlik bilgileri |
| `profile` | KullanÄ±cÄ± profil bilgileri | displayName, username, avatar, birthDate, about |
| `email` | E-posta adresi | email objesi (username, domain, isVerified) |
| `details` | Website ve konum bilgileri | website, location |
| `phone` | Telefon numarasÄ± | phone |

### Scope KullanÄ±mÄ±:

**TÃ¼m Scope'larÄ± Ä°steme:**
```
scope=openid profile email details phone
```

**Sadece Temel Bilgiler:**
```
scope=openid profile email
```

**Sadece Ä°letiÅŸim Bilgileri:**
```
scope=openid email phone
```

---

## ðŸ”„ OAuth AkÄ±ÅŸÄ±

### AdÄ±m 1: KullanÄ±cÄ± GiriÅŸi
```
KullanÄ±cÄ± â†’ Uygulama â†’ Authorization Endpoint
```

1. KullanÄ±cÄ± uygulamada "GiriÅŸ Yap" butonuna tÄ±klar
2. Uygulama authorization URL'ini oluÅŸturur
3. KullanÄ±cÄ± OAuth saÄŸlayÄ±cÄ±sÄ±nÄ±n giriÅŸ sayfasÄ±na yÃ¶nlendirilir

### AdÄ±m 2: Yetkilendirme
```
KullanÄ±cÄ± â†’ OAuth SaÄŸlayÄ±cÄ±sÄ± â†’ KullanÄ±cÄ±
```

1. KullanÄ±cÄ± kimlik bilgilerini girer
2. Ä°stenen izinleri onaylar
3. OAuth saÄŸlayÄ±cÄ±sÄ± authorization code Ã¼retir

### AdÄ±m 3: Kod DÃ¶nÃ¼ÅŸÃ¼
```
OAuth SaÄŸlayÄ±cÄ±sÄ± â†’ Uygulama (Callback)
```

1. OAuth saÄŸlayÄ±cÄ±sÄ± kullanÄ±cÄ±yÄ± callback URL'ine yÃ¶nlendirir
2. URL'de authorization code ve state parametreleri bulunur
3. Uygulama bu parametreleri alÄ±r

### AdÄ±m 4: Token DeÄŸiÅŸimi
```
Uygulama â†’ Token Endpoint â†’ OAuth SaÄŸlayÄ±cÄ±sÄ±
```

1. Uygulama authorization code'u token endpoint'ine gÃ¶nderir
2. OAuth saÄŸlayÄ±cÄ±sÄ± kodu doÄŸrular
3. Access token, refresh token ve id token dÃ¶ner

### AdÄ±m 5: Kaynak EriÅŸimi
```
Uygulama â†’ UserInfo Endpoint â†’ OAuth SaÄŸlayÄ±cÄ±sÄ±
```

1. Uygulama access token ile userinfo endpoint'ine istek gÃ¶nderir
2. KullanÄ±cÄ± bilgileri dÃ¶ner
3. Uygulama bu bilgileri kullanÄ±r

---

## ðŸ”’ GÃ¼venlik MekanizmalarÄ±

### 1. State Parametresi
**AmaÃ§:** CSRF (Cross-Site Request Forgery) saldÄ±rÄ±larÄ±nÄ± Ã¶nler

**NasÄ±l Ã‡alÄ±ÅŸÄ±r:**
1. Uygulama rastgele bir state deÄŸeri Ã¼retir
2. Bu deÄŸeri authorization isteÄŸinde gÃ¶nderir
3. Callback'te gelen state deÄŸerini kontrol eder
4. EÅŸleÅŸmezse isteÄŸi reddeder

### 2. PKCE (Proof Key for Code Exchange)
**AmaÃ§:** Authorization code interception saldÄ±rÄ±larÄ±nÄ± Ã¶nler

**NasÄ±l Ã‡alÄ±ÅŸÄ±r:**
1. **Code Verifier:** Uygulama rastgele bir string Ã¼retir
2. **Code Challenge:** Verifier'Ä±n SHA256 hash'i alÄ±nÄ±r
3. **Authorization:** Challenge gÃ¶nderilir
4. **Token Exchange:** Verifier gÃ¶nderilir

### 3. Client Secret
**AmaÃ§:** Uygulama kimliÄŸini doÄŸrular

### 4. Redirect URI DoÄŸrulama
**AmaÃ§:** Yetkisiz callback URL'lerini Ã¶nler

---

## ðŸŽ« Token TÃ¼rleri

### 1. Access Token
**AmaÃ§:** API kaynaklarÄ±na eriÅŸim saÄŸlar

**Ã–zellikler:**
- KÄ±sa Ã¶mÃ¼rlÃ¼ (genellikle 1 saat)
- Bearer token formatÄ±nda
- JWT veya opaque token olabilir

### 2. Refresh Token
**AmaÃ§:** Yeni access token almak iÃ§in kullanÄ±lÄ±r

**Ã–zellikler:**
- Uzun Ã¶mÃ¼rlÃ¼ (gÃ¼nler/haftalar)
- GÃ¼venli saklanmalÄ±
- Ä°steÄŸe baÄŸlÄ±

### 3. ID Token (OpenID Connect)
**AmaÃ§:** KullanÄ±cÄ± kimlik bilgilerini iÃ§erir

**Ã–zellikler:**
- JWT formatÄ±nda
- KullanÄ±cÄ± bilgilerini iÃ§erir
- Ä°mzalÄ± ve ÅŸifrelenmiÅŸ

---

## ðŸ“Š GerÃ§ek API YanÄ±tlarÄ±

### UserInfo Endpoint YanÄ±tÄ± (TÃ¼m Scope'lar Aktif)

**Ä°stek:**
```
GET /api/v2/oauth/userinfo
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

**YanÄ±t:**
```json
{
  "createdAt": "2025-08-16T05:41:37.055000+00:00",
  "id": "141417237180452864",
  "language": "en",
  "user": {
    "about": "In a world of ones and zeros, Duru was born to understand. Not just smart, but intuitive â€” your AI companion that learns, grows, and evolves with you.",
    "avatar": {
      "baseUrl": "https://id.cengel.studio",
      "color": "#000",
      "path": "/avatars/141417237180452864/latest"
    },
    "birthDate": "2004-12-28T00:00:00+00:00",
    "displayName": "duru!",
    "email": {
      "domain": "example.com",
      "isVerified": false,
      "username": "test"
    },
    "location": "Ulus, Ä°stanbul",
    "phone": "+90 533 163 63 08",
    "username": "duru",
    "website": "https://cengel.company"
  }
}
```

### Veri YapÄ±sÄ± Analizi

#### Ãœst Seviye Alanlar:
- `createdAt`: Hesap oluÅŸturma tarihi (ISO 8601 formatÄ±nda)
- `id`: KullanÄ±cÄ± benzersiz kimliÄŸi
- `language`: KullanÄ±cÄ± dil tercihi

#### User Objesi:
- `about`: KullanÄ±cÄ± hakkÄ±nda bilgi (profile scope)
- `avatar`: Profil resmi bilgileri (profile scope)
  - `baseUrl`: Avatar sunucu adresi
  - `color`: Avatar rengi
  - `path`: Avatar dosya yolu
- `birthDate`: DoÄŸum tarihi (profile scope)
- `displayName`: GÃ¶rÃ¼nen ad (profile scope)
- `email`: E-posta bilgileri (email scope)
  - `domain`: E-posta domain'i
  - `isVerified`: E-posta doÄŸrulama durumu
  - `username`: E-posta kullanÄ±cÄ± adÄ±
- `location`: Konum bilgisi (details scope)
- `phone`: Telefon numarasÄ± (phone scope)
- `username`: KullanÄ±cÄ± adÄ± (profile scope)
- `website`: Website adresi (details scope)

### Scope BazlÄ± YanÄ±t Ã–rnekleri

#### Sadece `openid profile` scope'larÄ±:
```json
{
  "createdAt": "2025-08-16T05:41:37.055000+00:00",
  "id": "141417237180452864",
  "language": "en",
  "user": {
    "about": "In a world of ones and zeros...",
    "avatar": {
      "baseUrl": "https://id.cengel.studio",
      "color": "#000",
      "path": "/avatars/141417237180452864/latest"
    },
    "birthDate": "2004-12-28T00:00:00+00:00",
    "displayName": "duru!",
    "username": "duru"
  }
}
```

#### Sadece `openid email` scope'larÄ±:
```json
{
  "createdAt": "2025-08-16T05:41:37.055000+00:00",
  "id": "141417237180452864",
  "language": "en",
  "user": {
    "email": {
      "domain": "example.com",
      "isVerified": false,
      "username": "test"
    }
  }
}
```

#### Sadece `openid details` scope'larÄ±:
```json
{
  "createdAt": "2025-08-16T05:41:37.055000+00:00",
  "id": "141417237180452864",
  "language": "en",
  "user": {
    "location": "Ulus, Ä°stanbul",
    "website": "https://cengel.company"
  }
}
```

#### Sadece `openid phone` scope'larÄ±:
```json
{
  "createdAt": "2025-08-16T05:41:37.055000+00:00",
  "id": "141417237180452864",
  "language": "en",
  "user": {
    "phone": "+90 533 163 63 08"
  }
}
```

---

## âš ï¸ Hata YÃ¶netimi

### 1. Authorization HatalarÄ±
**Hata Parametreleri:**
- `error`: Hata tÃ¼rÃ¼
- `error_description`: Hata aÃ§Ä±klamasÄ±
- `state`: Orijinal state deÄŸeri

**YaygÄ±n Hatalar:**
```
error=invalid_request
error=unauthorized_client
error=access_denied
error=unsupported_response_type
error=invalid_scope
error=server_error
error=temporarily_unavailable
```

### 2. Token HatalarÄ±
**HTTP Status Codes:**
- `400 Bad Request`: GeÃ§ersiz parametreler
- `401 Unauthorized`: GeÃ§ersiz client credentials
- `403 Forbidden`: Yetkisiz eriÅŸim

**Hata YanÄ±tÄ±:**
```json
{
  "error": "invalid_grant",
  "error_description": "The authorization code is invalid or expired"
}
```

### 3. UserInfo HatalarÄ±
**HTTP Status Codes:**
- `401 Unauthorized`: GeÃ§ersiz access token
- `403 Forbidden`: Yetersiz scope

---

## ðŸ“¡ API Ä°stekleri ve YanÄ±tlarÄ±

### Authorization Ä°steÄŸi (TÃ¼m Scope'lar)
```
GET /api/v2/oauth/authorize?
  response_type=code&
  client_id=pSsyy6i3D7rGyK8Hpt68Uw&
  redirect_uri=https://ozet.today/api/oauth-callback&
  scope=openid%20profile%20email%20details%20phone&
  state=abc123&
  code_challenge=xyz789&
  code_challenge_method=S256
```

**BaÅŸarÄ±lÄ± YanÄ±t:**
```
HTTP/1.1 302 Found
Location: https://ozet.today/api/oauth-callback?code=def456&state=abc123
```

### Token Ä°steÄŸi
```
POST /api/v2/oauth/token
Content-Type: application/json

{
  "grant_type": "authorization_code",
  "code": "def456",
  "redirect_uri": "https://ozet.today/api/oauth-callback",
  "client_id": "pSsyy6i3D7rGyK8Hpt68Uw",
  "code_verifier": "abc123"
}
```

**BaÅŸarÄ±lÄ± YanÄ±t:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "ghi789jkl012",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### UserInfo Ä°steÄŸi
```
GET /api/v2/oauth/userinfo
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## ðŸ”„ Refresh Token AkÄ±ÅŸÄ±

### Refresh Token Ä°steÄŸi
```
POST /api/v2/oauth/token
Content-Type: application/json

{
  "grant_type": "refresh_token",
  "refresh_token": "ghi789jkl012",
  "client_id": "pSsyy6i3D7rGyK8Hpt68Uw"
}
```

**BaÅŸarÄ±lÄ± YanÄ±t:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "mno345pqr678"
}
```

---

## ðŸ“Š OAuth AkÄ±ÅŸ DiyagramÄ±

```
KullanÄ±cÄ±                    Uygulama                    OAuth SaÄŸlayÄ±cÄ±sÄ±
   |                            |                              |
   | 1. GiriÅŸ Ä°steÄŸi            |                              |
   |--------------------------->|                              |
   |                            | 2. Authorization Ä°steÄŸi      |
   |                            |----------------------------->|
   |                            |                              | 3. GiriÅŸ SayfasÄ±
   |                            |                              |<-----------------------------|
   |                            |                              | 4. Kimlik DoÄŸrulama
   |                            |                              |<-----------------------------|
   |                            |                              | 5. Authorization Code
   |                            |<-----------------------------|
   | 6. Callback                |                              |
   |<---------------------------|                              |
   |                            | 7. Token Ä°steÄŸi              |
   |                            |----------------------------->|
   |                            | 8. Access Token              |
   |                            |<-----------------------------|
   |                            | 9. UserInfo Ä°steÄŸi           |
   |                            |----------------------------->|
   |                            | 10. KullanÄ±cÄ± Bilgileri      |
   |                            |<-----------------------------|
   | 11. GiriÅŸ TamamlandÄ±       |                              |
   |<---------------------------|                              |
```

---

## ðŸ›¡ï¸ GÃ¼venlik En Ä°yi UygulamalarÄ±

### 1. HTTPS KullanÄ±mÄ±
- TÃ¼m OAuth iletiÅŸimi HTTPS Ã¼zerinden yapÄ±lmalÄ±
- HTTP kullanÄ±mÄ± gÃ¼venlik aÃ§Ä±ÄŸÄ± oluÅŸturur

### 2. State Parametresi
- Her authorization isteÄŸinde benzersiz state kullanÄ±n
- Callback'te state doÄŸrulamasÄ± yapÄ±n

### 3. PKCE KullanÄ±mÄ±
- Public client'lar iÃ§in PKCE zorunludur
- Confidential client'lar iÃ§in de Ã¶nerilir

### 4. Token GÃ¼venliÄŸi
- Access token'larÄ± gÃ¼venli saklayÄ±n
- Refresh token'larÄ± ÅŸifreleyin
- Token'larÄ± client-side'da saklamayÄ±n

### 5. Scope SÄ±nÄ±rlama
- Sadece gerekli scope'larÄ± isteyin
- KullanÄ±cÄ±ya scope aÃ§Ä±klamasÄ± verin

### 6. Redirect URI DoÄŸrulama
- Sadece kayÄ±tlÄ± redirect URI'leri kabul edin
- Wildcard kullanÄ±mÄ±ndan kaÃ§Ä±nÄ±n

---

## ðŸ“ Ã–zet

Bu OAuth servisi:

1. **5 farklÄ± scope** sunar: `openid`, `profile`, `email`, `details`, `phone`
2. **Zengin kullanÄ±cÄ± verisi** dÃ¶ner (avatar, konum, website, telefon)
3. **Standart OAuth 2.0 protokolÃ¼** kullanÄ±r
4. **OpenID Connect** desteÄŸi saÄŸlar
5. **PKCE gÃ¼venlik** mekanizmasÄ± iÃ§erir
6. **Scope tabanlÄ± izin** sistemi sunar
7. **Token tabanlÄ± kimlik doÄŸrulama** yapar
8. **GÃ¼venli callback** mekanizmasÄ± iÃ§erir
9. **Hata yÃ¶netimi** saÄŸlar

Bu API, modern web uygulamalarÄ± iÃ§in gÃ¼venli ve kapsamlÄ± bir kimlik doÄŸrulama Ã§Ã¶zÃ¼mÃ¼ sunar.
